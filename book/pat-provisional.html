<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>临时措施</title>

    <link rel="stylesheet" type="text/css" href="rustbook.css">

    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
                <div id="nav">
                    <button id="toggle-nav">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </button>
                </div>
<div id='toc' class='mobile-hidden'>
<ol class='chapter'>
<li><a  href='README.html'><b>1.</b> Introduction</a>
</li>
<li><a  href='mbe-README.html'><b>2.</b> 宏，彻底剖析</a>
<ol class='section'>
<li><a  href='mbe-syn-README.html'><b>2.1.</b> 语法扩展</a>
<ol class='section'>
<li><a  href='mbe-syn-source-analysis.html'><b>2.1.1.</b> 源码解析过程</a>
</li>
<li><a  href='mbe-syn-macros-in-the-ast.html'><b>2.1.2.</b> AST中的宏</a>
</li>
<li><a  href='mbe-syn-expansion.html'><b>2.1.3.</b> 展开</a>
</li>
</ol>
</li>
<li><a  href='mbe-macro-rules.html'><b>2.2.</b> macro_rules!</a>
</li>
<li><a  href='mbe-min-README.html'><b>2.3.</b> 细枝末节</a>
<ol class='section'>
<li><a  href='mbe-min-captures-and-expansion-redux.html'><b>2.3.1.</b> 再探捕获与展开</a>
</li>
<li><a  href='mbe-min-hygiene.html'><b>2.3.2.</b> 卫生性</a>
</li>
<li><a  href='mbe-min-non-identifier-identifiers.html'><b>2.3.3.</b> 不是标识符的标识符</a>
</li>
<li><a  href='mbe-min-debugging.html'><b>2.3.4.</b> 调试</a>
</li>
<li><a  href='mbe-min-scoping.html'><b>2.3.5.</b> 作用域</a>
</li>
<li><a  href='mbe-min-import-export.html'><b>2.3.6.</b> 导入/导出</a>
</li>
</ol>
</li>
</ol>
</li>
<li><a  href='pim-README.html'><b>3.</b> 宏，实践介绍</a>
</li>
<li><a  href='pat-README.html'><b>4.</b> 常用模式</a>
<ol class='section'>
<li><a  href='pat-callbacks.html'><b>4.1.</b> 回调</a>
</li>
<li><a  href='pat-incremental-tt-munchers.html'><b>4.2.</b> 标记树撕咬机</a>
</li>
<li><a  href='pat-internal-rules.html'><b>4.3.</b> 内用规则</a>
</li>
<li><a  href='pat-push-down-accumulation.html'><b>4.4.</b> 下推累积</a>
</li>
<li><a  href='pat-repetition-replacement.html'><b>4.5.</b> 重复替代</a>
</li>
<li><a  href='pat-trailing-separators.html'><b>4.6.</b> 尾部分隔符</a>
</li>
<li><a  href='pat-tt-bundling.html'><b>4.7.</b> 标记树聚束</a>
</li>
<li><a  href='pat-visibility.html'><b>4.8.</b> 可见性</a>
</li>
<li><a class='active' href='pat-provisional.html'><b>4.9.</b> 临时措施</a>
</li>
</ol>
</li>
<li><a  href='blk-README.html'><b>5.</b> 轮子</a>
<ol class='section'>
<li><a  href='blk-ast-coercion.html'><b>5.1.</b> AST强转</a>
</li>
<li><a  href='blk-counting.html'><b>5.2.</b> 计数</a>
</li>
<li><a  href='blk-enum-parsing.html'><b>5.3.</b> 枚举解析</a>
</li>
</ol>
</li>
<li><a  href='aeg-README.html'><b>6.</b> 实例注解</a>
<ol class='section'>
<li><a  href='aeg-ook.html'><b>6.1.</b> Ook!</a>
</li>
</ol>
</li>
</ol>
</div>
<div id='page-wrapper'>
<div id='page'>


    <h1 class="title">临时措施</h1>
    <p>本节将留给那些价值有待探讨，以及那些可能有缺陷因而不适合出现在正文中的模式与技巧。</p>

<h2 id='算盘计数' class='section-header'><a href='#算盘计数'>算盘计数</a></h2>
<blockquote>
<p><strong>临时信息</strong>：需要更合适的例子。虽然它是<a href="aeg-ook.md#%E6%8F%90%E5%8F%96%E5%BE%AA%E7%8E%AF%E5%8C%BA%E5%9D%97"><code>Ook!</code>宏</a>的重要组成部分之一，但该用例——匹配Rust分组机制无法表示的嵌套结构——实在是过于特殊，因此不适作为例子使用。</p>

<p><strong>注意</strong>：此节预设读者了解<a href="pat-push-down-accumulation.html">下推累积</a>以及<a href="pat-incremental-tt-munchers.html">标记树撕咬机</a>。</p>
</blockquote>

<pre class='rust rust-example-rendered'>
<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>abacus</span> {
    ((<span class='op'>-</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>-&gt;</span> (<span class='op'>+</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>)) <span class='op'>=&gt;</span> {
        <span class='macro'>abacus</span><span class='macro'>!</span>(($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>)<span class='kw-2'>*</span>) <span class='op'>-&gt;</span> ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>)<span class='kw-2'>*</span>))
    };
    ((<span class='op'>-</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>-&gt;</span> ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>)) <span class='op'>=&gt;</span> {
        <span class='macro'>abacus</span><span class='macro'>!</span>(($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>)<span class='kw-2'>*</span>) <span class='op'>-&gt;</span> (<span class='op'>-</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>)<span class='kw-2'>*</span>))
    };
    ((<span class='op'>+</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>-&gt;</span> (<span class='op'>-</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>)) <span class='op'>=&gt;</span> {
        <span class='macro'>abacus</span><span class='macro'>!</span>(($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>)<span class='kw-2'>*</span>) <span class='op'>-&gt;</span> ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>)<span class='kw-2'>*</span>))
    };
    ((<span class='op'>+</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>-&gt;</span> ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>)) <span class='op'>=&gt;</span> {
        <span class='macro'>abacus</span><span class='macro'>!</span>(($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>)<span class='kw-2'>*</span>) <span class='op'>-&gt;</span> (<span class='op'>+</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>)<span class='kw-2'>*</span>))
    };

    <span class='comment'>// 检查最终结果是否为零</span>
    (() <span class='op'>-&gt;</span> ()) <span class='op'>=&gt;</span> { <span class='bool-val'>true</span> };
    (() <span class='op'>-&gt;</span> ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>:<span class='ident'>tt</span>)<span class='op'>+</span>)) <span class='op'>=&gt;</span> { <span class='bool-val'>false</span> };
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>equals_zero</span> <span class='op'>=</span> <span class='macro'>abacus</span><span class='macro'>!</span>((<span class='op'>+</span><span class='op'>+</span><span class='op'>-</span><span class='op'>+</span><span class='op'>-</span><span class='op'>+</span><span class='op'>+</span><span class='op'>+</span><span class='op'>-</span><span class='op'>-</span><span class='op'>+</span><span class='op'>+</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>+</span><span class='op'>+</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>-</span><span class='op'>+</span>) <span class='op'>-&gt;</span> ());
    <span class='macro'>assert_eq</span><span class='macro'>!</span>(<span class='ident'>equals_zero</span>, <span class='bool-val'>true</span>);
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=macro_rules!%20abacus%20%7B%0A%20%20%20%20((-%20%24(%24moves%3Att)*)%20-%3E%20(%2B%20%24(%24count%3Att)*))%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20abacus!((%24(%24moves)*)%20-%3E%20(%24(%24count)*))%0A%20%20%20%20%7D%3B%0A%20%20%20%20((-%20%24(%24moves%3Att)*)%20-%3E%20(%24(%24count%3Att)*))%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20abacus!((%24(%24moves)*)%20-%3E%20(-%20%24(%24count)*))%0A%20%20%20%20%7D%3B%0A%20%20%20%20((%2B%20%24(%24moves%3Att)*)%20-%3E%20(-%20%24(%24count%3Att)*))%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20abacus!((%24(%24moves)*)%20-%3E%20(%24(%24count)*))%0A%20%20%20%20%7D%3B%0A%20%20%20%20((%2B%20%24(%24moves%3Att)*)%20-%3E%20(%24(%24count%3Att)*))%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20abacus!((%24(%24moves)*)%20-%3E%20(%2B%20%24(%24count)*))%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20%2F%2F%20%E6%A3%80%E6%9F%A5%E6%9C%80%E7%BB%88%E7%BB%93%E6%9E%9C%E6%98%AF%E5%90%A6%E4%B8%BA%E9%9B%B6%0A%20%20%20%20(()%20-%3E%20())%20%3D%3E%20%7B%20true%20%7D%3B%0A%20%20%20%20(()%20-%3E%20(%24(%24count%3Att)%2B))%20%3D%3E%20%7B%20false%20%7D%3B%0A%7D%0A%0Afn%20main()%20%7B%0A%20%20%20%20let%20equals_zero%20%3D%20abacus!((%2B%2B-%2B-%2B%2B%2B--%2B%2B---%2B%2B----%2B)%20-%3E%20())%3B%0A%20%20%20%20assert_eq!(equals_zero%2C%20true)%3B%0A%7D%0A">Run</a></pre>

<p>当需要记录的计数会发生变化，且初始值为零或在零附近，且必须支持如下操作：</p>

<ul>
<li>增加一；</li>
<li>减少一；</li>
<li>与0(或任何其它固定有限值)相比较；</li>
</ul>

<p>时，可以使用次技巧。</p>

<p>数值n将由一组共n个相同的特定标记来表示。对数值的修改操作将采用<a href="pat-push-down-accumulation.html">下推累积</a>模式由递归调用完成。假设所采用的特定标记是<code>x</code>，则上述操作可实现为：</p>

<ul>
<li>增加一：匹配<code>($($count:tt)*)</code>并替换为<code>(x $($count)*)</code>。</li>
<li>减少一：匹配<code>(x $($count:tt)*)</code>并替换为<code>($($count)*)</code>。</li>
<li>与0相比较：匹配<code>()</code>。</li>
<li>与1相比较：匹配<code>(x)</code>。</li>
<li>与2相比较：匹配<code>(x x)</code>。</li>
<li><em>(依此类推...)</em></li>
</ul>

<p>作用于计数值的操作将所选的标记来回摆动，如同算盘摆动算子。<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup></p>

<p>在想表示负数的情况下，值<em>-n</em>可被表示成<em>n</em>个相同的其它标记。在上例中，值<em>+n</em>被表示成<em>n</em>个<code>+</code>标记，而值<em>-m</em>被表示成<em>m</em>个<code>-</code>标记。</p>

<p>有负数的情况下操作起来稍微复杂一些，增减操作在当前数值为负时实际上互换了角色。给定<code>+</code>和<code>-</code>分别作为正数与负数标记，相应操作的实现将变成：</p>

<ul>
<li>增加一：

<ul>
<li>匹配<code>()</code>并替换为<code>(+)</code></li>
<li>匹配<code>(- $($count:tt)*)</code>并替换为<code>($($count)*)</code></li>
<li>匹配<code>($($count:tt)+)</code>并替换为<code>(+ $($count)+)</code></li>
</ul></li>
<li>减少一：

<ul>
<li>匹配<code>()</code>并替换为<code>(-)</code></li>
<li>匹配<code>(+ $($count:tt)*)</code>并替换为<code>($($count)*)</code></li>
<li>匹配<code>($($count:tt)+)</code>并替换为<code>(- $($count)+)</code></li>
</ul></li>
<li>与0相比较：匹配 <code>()</code></li>
<li>与+1相比较：匹配<code>(+)</code></li>
<li>与-1相比较：匹配<code>(-)</code></li>
<li>与+2相比较：匹配<code>(++)</code></li>
<li>与-2相比较：匹配<code>(--)</code></li>
<li><em>(依此类推...)</em></li>
</ul>

<p>注意在顶部的示例中，某些规则被合并到一起了(举例来说，对<code>()</code>及<code>($($count:tt)+)</code>的增加操作被合并为对<code>($($count:tt)*)</code>的增加操作)。</p>

<p>如果想要提取出所计数目的实际值，可再使用普通的<a href="blk-counting.html">计数宏</a>。对上例来说，终结规则可换为：</p>

<pre class='rust rust-example-rendered'>
<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>abacus</span> {
    <span class='comment'>// ...</span>

    <span class='comment'>// 下列规则将计数替换成实际值的表达式</span>
    (() <span class='op'>-&gt;</span> ()) <span class='op'>=&gt;</span> {<span class='number'>0</span>};
    (() <span class='op'>-&gt;</span> (<span class='op'>-</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>)) <span class='op'>=&gt;</span> {
        {(<span class='op'>-</span><span class='number'>1i32</span>) $(<span class='op'>-</span> <span class='macro'>replace_expr</span><span class='macro'>!</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span> <span class='number'>1i32</span>))<span class='kw-2'>*</span>}
    };
    (() <span class='op'>-&gt;</span> (<span class='op'>+</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>)) <span class='op'>=&gt;</span> {
        {(<span class='number'>1i32</span>) $(<span class='op'>+</span> <span class='macro'>replace_expr</span><span class='macro'>!</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>count</span> <span class='number'>1i32</span>))<span class='kw-2'>*</span>}
    };
}

<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>replace_expr</span> {
    (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>_t</span>:<span class='ident'>tt</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>sub</span>:<span class='ident'>expr</span>) <span class='op'>=&gt;</span> {<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>sub</span>};
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Amacro_rules!%20abacus%20%7B%0A%20%20%20%20%2F%2F%20...%0A%0A%20%20%20%20%2F%2F%20%E4%B8%8B%E5%88%97%E8%A7%84%E5%88%99%E5%B0%86%E8%AE%A1%E6%95%B0%E6%9B%BF%E6%8D%A2%E6%88%90%E5%AE%9E%E9%99%85%E5%80%BC%E7%9A%84%E8%A1%A8%E8%BE%BE%E5%BC%8F%0A%20%20%20%20(()%20-%3E%20())%20%3D%3E%20%7B0%7D%3B%0A%20%20%20%20(()%20-%3E%20(-%20%24(%24count%3Att)*))%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%7B(-1i32)%20%24(-%20replace_expr!(%24count%201i32))*%7D%0A%20%20%20%20%7D%3B%0A%20%20%20%20(()%20-%3E%20(%2B%20%24(%24count%3Att)*))%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%7B(1i32)%20%24(%2B%20replace_expr!(%24count%201i32))*%7D%0A%20%20%20%20%7D%3B%0A%7D%0A%0Amacro_rules!%20replace_expr%20%7B%0A%20%20%20%20(%24_t%3Att%20%24sub%3Aexpr)%20%3D%3E%20%7B%24sub%7D%3B%0A%7D%0A%7D">Run</a></pre>

<blockquote>
<p><strong><abbr title="Just for this example">仅限此例</abbr></strong>：严格来说，想要达到此例的效果，没必要做的这么复杂。如果你不需要在宏中匹配所计的值，可直接采用重复来更加高效地实现：</p>

<pre class='rust rust-example-rendered'>
<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>abacus</span> {
    (<span class='op'>-</span>) <span class='op'>=&gt;</span> {<span class='op'>-</span><span class='number'>1</span>};
    (<span class='op'>+</span>) <span class='op'>=&gt;</span> {<span class='number'>1</span>};
    ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>=&gt;</span> {
        <span class='number'>0</span> $(<span class='op'>+</span> <span class='macro'>abacus</span><span class='macro'>!</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>moves</span>))<span class='op'>*</span>
    }
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Amacro_rules!%20abacus%20%7B%0A%20%20%20%20(-)%20%3D%3E%20%7B-1%7D%3B%0A%20%20%20%20(%2B)%20%3D%3E%20%7B1%7D%3B%0A%20%20%20%20(%24(%24moves%3Att)*)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%200%20%24(%2B%20abacus!(%24moves))*%0A%20%20%20%20%7D%0A%7D%0A%7D">Run</a></pre>
</blockquote>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>在这句极度单薄的辩解下，隐藏着选用此名称的<em>真实</em>理由：避免造出又一个名含“标记”的术语。今天就该跟你认识的作者谈谈规避<a href="https://en.wikipedia.org/wiki/Semantic_satiation">语义饱和</a>吧！公平来讲，本来也可以称它为<a href="https://en.wikipedia.org/wiki/Unary_numeral_system">“一元计数(unary counting)”</a>。&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

    <script src='rustbook.js'></script>
</div></div>


</body>
</html>