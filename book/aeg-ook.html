<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Ook!</title>

    <link rel="stylesheet" type="text/css" href="rustbook.css">

    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
                <div id="nav">
                    <button id="toggle-nav">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </button>
                </div>
<div id='toc' class='mobile-hidden'>
<ol class='chapter'>
<li><a  href='README.html'><b>1.</b> Introduction</a>
</li>
<li><a  href='mbe-README.html'><b>2.</b> 宏，彻底剖析</a>
<ol class='section'>
<li><a  href='mbe-syn-README.html'><b>2.1.</b> 语法扩展</a>
<ol class='section'>
<li><a  href='mbe-syn-source-analysis.html'><b>2.1.1.</b> 源码解析过程</a>
</li>
<li><a  href='mbe-syn-macros-in-the-ast.html'><b>2.1.2.</b> AST中的宏</a>
</li>
<li><a  href='mbe-syn-expansion.html'><b>2.1.3.</b> 展开</a>
</li>
</ol>
</li>
<li><a  href='mbe-macro-rules.html'><b>2.2.</b> macro_rules!</a>
</li>
<li><a  href='mbe-min-README.html'><b>2.3.</b> 细枝末节</a>
<ol class='section'>
<li><a  href='mbe-min-captures-and-expansion-redux.html'><b>2.3.1.</b> 再探捕获与展开</a>
</li>
<li><a  href='mbe-min-hygiene.html'><b>2.3.2.</b> 卫生性</a>
</li>
<li><a  href='mbe-min-non-identifier-identifiers.html'><b>2.3.3.</b> 不是标识符的标识符</a>
</li>
<li><a  href='mbe-min-debugging.html'><b>2.3.4.</b> 调试</a>
</li>
<li><a  href='mbe-min-scoping.html'><b>2.3.5.</b> 作用域</a>
</li>
<li><a  href='mbe-min-import-export.html'><b>2.3.6.</b> 导入/导出</a>
</li>
</ol>
</li>
</ol>
</li>
<li><a  href='pim-README.html'><b>3.</b> 宏，实践介绍</a>
</li>
<li><a  href='pat-README.html'><b>4.</b> 常用模式</a>
<ol class='section'>
<li><a  href='pat-callbacks.html'><b>4.1.</b> 回调</a>
</li>
<li><a  href='pat-incremental-tt-munchers.html'><b>4.2.</b> 标记树撕咬机</a>
</li>
<li><a  href='pat-internal-rules.html'><b>4.3.</b> 内用规则</a>
</li>
<li><a  href='pat-push-down-accumulation.html'><b>4.4.</b> 下推累积</a>
</li>
<li><a  href='pat-repetition-replacement.html'><b>4.5.</b> 重复替代</a>
</li>
<li><a  href='pat-trailing-separators.html'><b>4.6.</b> 尾部分隔符</a>
</li>
<li><a  href='pat-tt-bundling.html'><b>4.7.</b> 标记树聚束</a>
</li>
<li><a  href='pat-visibility.html'><b>4.8.</b> 可见性</a>
</li>
<li><a  href='pat-provisional.html'><b>4.9.</b> 临时措施</a>
</li>
</ol>
</li>
<li><a  href='blk-README.html'><b>5.</b> 轮子</a>
<ol class='section'>
<li><a  href='blk-ast-coercion.html'><b>5.1.</b> AST强转</a>
</li>
<li><a  href='blk-counting.html'><b>5.2.</b> 计数</a>
</li>
<li><a  href='blk-enum-parsing.html'><b>5.3.</b> 枚举解析</a>
</li>
</ol>
</li>
<li><a  href='aeg-README.html'><b>6.</b> 实例注解</a>
<ol class='section'>
<li><a class='active' href='aeg-ook.html'><b>6.1.</b> Ook!</a>
</li>
</ol>
</li>
</ol>
</div>
<div id='page-wrapper'>
<div id='page'>


    <h1 class="title">Ook!</h1>
    <p>此宏是对<a href="http://www.dangermouse.net/esoteric/ook.html">Ook!密文</a>的实现，该语言与<a href="http://www.muppetlabs.com/%7Ebreadbox/bf/">Brainfuck密文</a>同构。</p>

<p>此语言的执行模式非常简单：内存被表示为一列总量不定(通常至少包括30,000个)的“单元”(每个单元至少8bit)；另有一个指向该内存的指针，最初指向位置0；还有一个执行栈(用来实现循环)和一个指向程序代码的指针。最后两个组件并未暴露给程序本身，它们属于程序的运行时性质。</p>

<p>语言本身仅由三种标记，<code>Ook.</code>、<code>Ook?</code>及<code>Ook!</code>构成。它们两两组合，构成了八种运算符：</p>

<ul>
<li><code>Ook. Ook?</code> - 指针增。</li>
<li><code>Ook? Ook.</code> - 指针减。</li>
<li><code>Ook. Ook.</code> - 所指单元增。</li>
<li><code>Ook! Ook!</code> - 所指单元减。</li>
<li><code>Ook! Ook.</code> - 将所指单元写至标准输出。</li>
<li><code>Ook. Ook!</code> - 从标准输入读至所指单元。</li>
<li><code>Ook! Ook?</code> - 进入循环。</li>
<li><code>Ook? Ook!</code> - 如果所指单元非零，跳回循环起始位置；否则，继续执行。</li>
</ul>

<p>Ook!之所以有趣，是因为它图灵完备。这意味着，你必须要在同样图灵完备的环境中才能实现它。</p>

<h2 id='实现' class='section-header'><a href='#实现'>实现</a></h2>
<pre class='rust rust-example-rendered'>
<span class='attribute'>#<span class='op'>!</span>[<span class='ident'>recursion_limit</span> <span class='op'>=</span> <span class='string'>&quot;158&quot;</span>]</span><a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%23!%5Brecursion_limit%20%3D%20%22158%22%5D%0A%7D">Run</a></pre>

<p>实际上，这个值将是我们随后给出的示例程序编译成功所需的最低值。如果你很好奇究竟是怎样的程序，会如此这般复杂，以至于必须要把递归极限调至默认值的近五倍大... <a href="https://en.wikipedia.org/wiki/Hello_world_program">请大胆猜测</a>。</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>type</span> <span class='ident'>CellType</span> <span class='op'>=</span> <span class='ident'>u8</span>;
<span class='kw'>const</span> <span class='ident'>MEM_SIZE</span>: <span class='ident'>usize</span> <span class='op'>=</span> <span class='number'>30_000</span>;<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Atype%20CellType%20%3D%20u8%3B%0Aconst%20MEM_SIZE%3A%20usize%20%3D%2030_000%3B%0A%7D">Run</a></pre>

<p>加入这些定义，以供宏展开使用<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup></p>

<pre class='rust rust-example-rendered'>
<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>Ook</span> {<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Amacro_rules!%20Ook%20%7B%0A%7D">Run</a></pre>

<p>可能应该取名<code>ook!</code>以符合Rust标准的命名传统。然而良机不可错失，我们就用本名吧！</p>

<p>我们使用了<a href="pat-internal-rules.html">内用规则</a>模式；此宏的规则因而可被分为几个模块。</p>

<p>第一块是<code>@start</code>规则，负责为之后的展开搭建舞台。没什么特别的地方：先定义一些变量、效用函数，然后处理展开的大头。</p>

<p>一些脚注：</p>

<ul>
<li>我们之所以选择展开为函数，很大原因在于，这样以来就可以采用<code>try!</code>来简化错误处理流程。</li>
<li>有些时候，举例来说，如果用户想写一个不做I/O的程序，那么I/O相关的名称就不会被用到。我们让部分名称以<code>_</code>起头，正是为了使编译器不对此类情况产生抱怨。</li>
</ul>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>start</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>Ooks</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>=&gt;</span> {
        {
            <span class='kw'>fn</span> <span class='ident'>ook</span>() <span class='op'>-&gt;</span> ::<span class='ident'>std</span>::<span class='ident'>io</span>::<span class='prelude-ty'>Result</span><span class='op'>&lt;</span><span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>CellType</span><span class='op'>&gt;&gt;</span> {
                <span class='kw'>use</span> ::<span class='ident'>std</span>::<span class='ident'>io</span>;
                <span class='kw'>use</span> ::<span class='ident'>std</span>::<span class='ident'>io</span>::<span class='ident'>prelude</span>::<span class='kw-2'>*</span>;
    
                <span class='kw'>fn</span> <span class='ident'>_re</span>() <span class='op'>-&gt;</span> <span class='ident'>io</span>::<span class='ident'>Error</span> {
                    <span class='ident'>io</span>::<span class='ident'>Error</span>::<span class='ident'>new</span>(
                        <span class='ident'>io</span>::<span class='ident'>ErrorKind</span>::<span class='ident'>Other</span>,
                        <span class='ident'>String</span>::<span class='ident'>from</span>(<span class='string'>&quot;ran out of input&quot;</span>))
                }
                
                <span class='kw'>fn</span> <span class='ident'>_inc</span>(<span class='ident'>a</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> [<span class='ident'>u8</span>], <span class='ident'>i</span>: <span class='ident'>usize</span>) {
                    <span class='kw'>let</span> <span class='ident'>c</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>a</span>[<span class='ident'>i</span>];
                    <span class='kw-2'>*</span><span class='ident'>c</span> <span class='op'>=</span> <span class='ident'>c</span>.<span class='ident'>wrapping_add</span>(<span class='number'>1</span>);
                }
                
                <span class='kw'>fn</span> <span class='ident'>_dec</span>(<span class='ident'>a</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> [<span class='ident'>u8</span>], <span class='ident'>i</span>: <span class='ident'>usize</span>) {
                    <span class='kw'>let</span> <span class='ident'>c</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>a</span>[<span class='ident'>i</span>];
                    <span class='kw-2'>*</span><span class='ident'>c</span> <span class='op'>=</span> <span class='ident'>c</span>.<span class='ident'>wrapping_sub</span>(<span class='number'>1</span>);
                }
    
                <span class='kw'>let</span> <span class='ident'>_r</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>io</span>::<span class='ident'>stdin</span>();
                <span class='kw'>let</span> <span class='ident'>_w</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>io</span>::<span class='ident'>stdout</span>();
        
                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>_a</span>: <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>CellType</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>Vec</span>::<span class='ident'>with_capacity</span>(<span class='ident'>MEM_SIZE</span>);
                <span class='ident'>_a</span>.<span class='ident'>extend</span>(::<span class='ident'>std</span>::<span class='ident'>iter</span>::<span class='ident'>repeat</span>(<span class='number'>0</span>).<span class='ident'>take</span>(<span class='ident'>MEM_SIZE</span>));
                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>_i</span> <span class='op'>=</span> <span class='number'>0</span>;
                {
                    <span class='kw'>let</span> <span class='ident'>_a</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='kw-2'>*</span><span class='ident'>_a</span>;
                    <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='ident'>_a</span>, <span class='ident'>_i</span>, <span class='ident'>_inc</span>, <span class='ident'>_dec</span>, <span class='ident'>_r</span>, <span class='ident'>_w</span>, <span class='ident'>_re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>Ooks</span>)<span class='kw-2'>*</span>));
                }
                <span class='prelude-val'>Ok</span>(<span class='ident'>_a</span>)
            }
            <span class='ident'>ook</span>()
        }
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40start%20%24(%24Ooks%3Att)*)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20fn%20ook()%20-%3E%20%3A%3Astd%3A%3Aio%3A%3AResult%3CVec%3CCellType%3E%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20use%20%3A%3Astd%3A%3Aio%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20use%20%3A%3Astd%3A%3Aio%3A%3Aprelude%3A%3A*%3B%0A%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fn%20_re()%20-%3E%20io%3A%3AError%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20io%3A%3AError%3A%3Anew(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20io%3A%3AErrorKind%3A%3AOther%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20String%3A%3Afrom(%22ran%20out%20of%20input%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fn%20_inc(a%3A%20%26mut%20%5Bu8%5D%2C%20i%3A%20usize)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20c%20%3D%20%26mut%20a%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20*c%20%3D%20c.wrapping_add(1)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fn%20_dec(a%3A%20%26mut%20%5Bu8%5D%2C%20i%3A%20usize)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20c%20%3D%20%26mut%20a%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20*c%20%3D%20c.wrapping_sub(1)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20_r%20%3D%20%26mut%20io%3A%3Astdin()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20_w%20%3D%20%26mut%20io%3A%3Astdout()%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20mut%20_a%3A%20Vec%3CCellType%3E%20%3D%20Vec%3A%3Awith_capacity(MEM_SIZE)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_a.extend(%3A%3Astd%3A%3Aiter%3A%3Arepeat(0).take(MEM_SIZE))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20mut%20_i%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20_a%20%3D%20%26mut%20*_a%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Ook!(%40e%20(_a%2C%20_i%2C%20_inc%2C%20_dec%2C%20_r%2C%20_w%2C%20_re)%3B%20(%24(%24Ooks)*))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Ok(_a)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20ook()%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<h3 id='解析运算符码' class='section-header'><a href='#解析运算符码'>解析运算符码</a></h3>
<p>接下来，是一列“执行”规则，用于从输入中解析运算符码。</p>

<p>这列规则的通用形式是<code>(@e $syms; ($input))</code>。从<code>@start</code>规则种我们可以看出，<code>$syms</code>包含了实现Ook程序所必须的符号：输入、输出、内存等等。我们使用了<a href="pat-tt-bundling.html">标记树聚束</a>来简化转发这些符号的流程。</p>

<p>第一条规则是终止规则：一旦没有更多输入，我们就停下来。</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>e</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ()) <span class='op'>=&gt;</span> {};<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40e%20%24syms%3Att%3B%20())%20%3D%3E%20%7B%7D%3B%0A%7D">Run</a></pre>

<p>其次，是一些适用于绝大部分运算符码的规则：我们剥下运算符码，换上其相应的Rust代码，然后继续递归处理输入剩下的部分。教科书式的<a href="pat-incremental-tt-munchers.html">标记树撕咬机</a>。</p>

<pre class='rust rust-example-rendered'>
    <span class='comment'>// 指针增</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> <span class='op'>=</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> <span class='op'>+</span> <span class='number'>1</span>) <span class='op'>%</span> <span class='ident'>MEM_SIZE</span>;
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// 指针减</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>. $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> <span class='op'>==</span> <span class='number'>0</span> { <span class='ident'>MEM_SIZE</span> } <span class='kw'>else</span> { <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> } <span class='op'>-</span> <span class='number'>1</span>;
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// 所指增</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='ident'>Ook</span>. <span class='ident'>Ook</span>. $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>);
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// 所指减</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>);
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// 输出</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>. $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>try</span><span class='macro'>!</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>.<span class='ident'>write_all</span>(<span class='kw-2'>&amp;</span><span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>[<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> .. <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span><span class='op'>+</span><span class='number'>1</span>]));
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// 读入</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='ident'>Ook</span>. <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>try</span><span class='macro'>!</span>(
            <span class='kw'>match</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>.<span class='ident'>read</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>[<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> .. <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span><span class='op'>+</span><span class='number'>1</span>]) {
                <span class='prelude-val'>Ok</span>(<span class='number'>0</span>) <span class='op'>=&gt;</span> <span class='prelude-val'>Err</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>()),
                <span class='ident'>ok</span> @ <span class='prelude-val'>Ok</span>(..) <span class='op'>=&gt;</span> <span class='ident'>ok</span>,
                <span class='ident'>err</span> @ <span class='prelude-val'>Err</span>(..) <span class='op'>=&gt;</span> <span class='ident'>err</span>
            }
        );
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20%2F%2F%20%E6%8C%87%E9%92%88%E5%A2%9E%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook.%20Ook%3F%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%24i%20%3D%20(%24i%20%2B%201)%20%25%20MEM_SIZE%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E6%8C%87%E9%92%88%E5%87%8F%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook.%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%24i%20%3D%20if%20%24i%20%3D%3D%200%20%7B%20MEM_SIZE%20%7D%20else%20%7B%20%24i%20%7D%20-%201%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E6%89%80%E6%8C%87%E5%A2%9E%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook.%20Ook.%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%24inc(%24a%2C%20%24i)%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E6%89%80%E6%8C%87%E5%87%8F%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%24dec(%24a%2C%20%24i)%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%BE%93%E5%87%BA%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook.%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20try!(%24w.write_all(%26%24a%5B%24i%20..%20%24i%2B1%5D))%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20%E8%AF%BB%E5%85%A5%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook.%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20try!(%0A%20%20%20%20%20%20%20%20%20%20%20%20match%20%24r.read(%26mut%20%24a%5B%24i%20..%20%24i%2B1%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Ok(0)%20%3D%3E%20Err(%24re())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ok%20%40%20Ok(..)%20%3D%3E%20ok%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20err%20%40%20Err(..)%20%3D%3E%20err%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20)%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<p>现在要弄复杂的了。运算符码<code>Ook! Ook?</code>标记着循环的开始。Ook!中的循环，翻译成Rust代码的话，类似：</p>

<blockquote>
<p><strong>注意</strong>：这不是宏定义的组成部分。</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>while</span> <span class='ident'>memory</span>[<span class='ident'>ptr</span>] <span class='op'>!=</span> <span class='number'>0</span> {
    <span class='comment'>// 循环内容</span>
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Awhile%20memory%5Bptr%5D%20!%3D%200%20%7B%0A%20%20%20%20%2F%2F%20%E5%BE%AA%E7%8E%AF%E5%86%85%E5%AE%B9%0A%7D%0A%7D">Run</a></pre>
</blockquote>

<p>显然，我们无法为中间步骤生成不完整的循环。这一问题似可用<a href="pat-push-down-accumulation.html">下推累积</a>解决，但更根本的困难在于，我们无论如何都没办法生成类似<code>while memory[ptr] != {</code>的中间结果，完全不可能。因为它引入了不匹配的花括号。</p>

<p>解决方法是，把输入分成两部分：循环内部的，循环之后的。前者由<code>@x</code>规则处理，后者由<code>@s</code>处理。</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='kw'>while</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>[<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>] <span class='op'>!=</span> <span class='number'>0</span> {
            <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>x</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); (); (); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
        }
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>s</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); (); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook%3F%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20while%20%24a%5B%24i%5D%20!%3D%200%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20Ook!(%40x%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20()%3B%20()%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20Ook!(%40s%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20()%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<h3 id='提取循环区块' class='section-header'><a href='#提取循环区块'>提取循环区块</a></h3>
<p>接下来是“提取”规则组<code>@x</code>。它们负责接受输入尾，并将之展开为循环的内容。这组规则的一般形式为：<code>(@x $sym; $depth; $buf; $tail)</code>。</p>

<p><code>$sym</code>的用处与上相同。<code>$tail</code>表示需要被解析的输入；而<code>$buf</code>则作为<a href="pat-push-down-accumulation.html">下推累积的缓存</a>，循环内的运算符码在经过解析后将被存入其中。那么，<code>$depth</code>代表什么？</p>

<p>目前为止，我们还未提及如何处理嵌套循环。<code>$depth</code>的作用正在于此：我们需要记录当前循环在整个嵌套之中的深度，同时保证解析不会过早或过晚终止，而是刚好停在恰当的位置。<sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup></p>

<p>由于在宏中没办法进行计算，而将数目匹配规则一一列出又不太可行(想想下面这一整套规则都得复制粘贴一堆不算小的整数的话，会是什么样子)，我们将只好回头采用最古老最珍贵的计数方法之一：亲手去数。</p>

<p>当然了，宏没有手，我们实际采用的是<a href="pat-provisional.md#%E7%AE%97%E7%9B%98%E8%AE%A1%E6%95%B0">算盘计数模式</a>。具体来说，我们选用标记<code>@</code>，每个<code>@</code>都表示新的一层嵌套。把这些<code>@</code>们放进一组后，我们就可以实现所需的操作了：</p>

<ul>
<li>增加层数：匹配<code>($($depth:tt)*)</code>并用<code>(@ $($depth)*)</code>替换。</li>
<li>减少层数：匹配<code>(@ $($depth:tt)*)</code>并用<code>($($depth)*)</code>替换。</li>
<li>与0相比较：匹配<code>()</code>。</li>
</ul>

<p>规则组中的第一条规则，用于在找到 <code>Ook? Ook!</code>输入序列时，终止当前循环体的解析。随后，我们需要把累积所得的循环体内容发给先前定义的<code>@e</code>组规则。</p>

<p>注意，规则对于输入所剩的尾部不作任何处理(这项工作将由<code>@s</code>组的规则完成)。</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; (); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='comment'>// 最外层的循环已被处理完毕，现在转而处理缓存到的标记。</span>
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40x%20%24syms%3Att%3B%20()%3B%20(%24(%24buf%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E6%9C%80%E5%A4%96%E5%B1%82%E7%9A%84%E5%BE%AA%E7%8E%AF%E5%B7%B2%E8%A2%AB%E5%A4%84%E7%90%86%E5%AE%8C%E6%AF%95%EF%BC%8C%E7%8E%B0%E5%9C%A8%E8%BD%AC%E8%80%8C%E5%A4%84%E7%90%86%E7%BC%93%E5%AD%98%E5%88%B0%E7%9A%84%E6%A0%87%E8%AE%B0%E3%80%82%0A%20%20%20%20%20%20%20%20Ook!(%40e%20%24syms%3B%20(%24(%24buf)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<p>紧接着，是负责进出嵌套的一些规则。它们修改深度计数，并将运算符码放入缓存。</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='comment'>// 嵌套变深</span>
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; (@ $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>)<span class='op'>*</span> <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    (@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; (@ $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='comment'>// 嵌套变浅</span>
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>)<span class='op'>*</span> <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40x%20%24syms%3Att%3B%20(%24(%24depth%3Att)*)%3B%20(%24(%24buf%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook%3F%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%B5%8C%E5%A5%97%E5%8F%98%E6%B7%B1%0A%20%20%20%20%20%20%20%20Ook!(%40x%20%24syms%3B%20(%40%20%24(%24depth)*)%3B%20(%24(%24buf)*%20Ook!%20Ook%3F)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20(%40x%20%24syms%3Att%3B%20(%40%20%24(%24depth%3Att)*)%3B%20(%24(%24buf%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20%E5%B5%8C%E5%A5%97%E5%8F%98%E6%B5%85%0A%20%20%20%20%20%20%20%20Ook!(%40x%20%24syms%3B%20(%24(%24depth)*)%3B%20(%24(%24buf)*%20Ook%3F%20Ook!)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<p>最后剩下的所有情况将交由一条规则处理。注意到它用的<code>$op0</code>和<code>$op1</code>两处捕获；对于Rust来说，Ook!中的一个标记将被视作两个标记：标识符<code>Ook</code>与剩下的符号。因此，我们用此规则来处理其它任何Ook!的非循环运算符，将<code>!</code>, <code>?</code>和<code>.</code>作为<code>tt</code>匹配，并捕获之。</p>

<p>我们放置<code>$depth</code>，仅将运算符码推至缓存区中。</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op0</span>:<span class='ident'>tt</span> <span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op1</span>:<span class='ident'>tt</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>)<span class='op'>*</span> <span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op0</span> <span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op1</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40x%20%24syms%3Att%3B%20%24depth%3Att%3B%20(%24(%24buf%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%20%24op0%3Att%20Ook%20%24op1%3Att%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40x%20%24syms%3B%20%24depth%3B%20(%24(%24buf)*%20Ook%20%24op0%20Ook%20%24op1)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<h3 id='跳过循环区块' class='section-header'><a href='#跳过循环区块'>跳过循环区块</a></h3>
<p>这组规则与循环提取大致相同，不过它们并不关心循环的内容(也因此不需要累积缓存)。它们仅仅关心循环何时被完全跳过。彼时，我们将恢复到<code>@e</code>组规则中并继续处理剩下的输入。</p>

<p>因此，我们将不加进一步说明地列出它们：</p>

<pre class='rust rust-example-rendered'>
    <span class='comment'>// End of loop.</span>
    (@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ();
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };

    <span class='comment'>// Enter nested loop.</span>
    (@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; (@ $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// Exit nested loop.</span>
    (@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; (@ $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };

    <span class='comment'>// Not a loop opcode.</span>
    (@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op0</span>:<span class='ident'>tt</span> <span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op1</span>:<span class='ident'>tt</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20%2F%2F%20End%20of%20loop.%0A%20%20%20%20(%40s%20%24syms%3Att%3B%20()%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20%24syms%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20%2F%2F%20Enter%20nested%20loop.%0A%20%20%20%20(%40s%20%24syms%3Att%3B%20(%24(%24depth%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook%3F%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40s%20%24syms%3B%20(%40%20%24(%24depth)*)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Exit%20nested%20loop.%0A%20%20%20%20(%40s%20%24syms%3Att%3B%20(%40%20%24(%24depth%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40s%20%24syms%3B%20(%24(%24depth)*)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20%2F%2F%20Not%20a%20loop%20opcode.%0A%20%20%20%20(%40s%20%24syms%3Att%3B%20(%24(%24depth%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%20%24op0%3Att%20Ook%20%24op1%3Att%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40s%20%24syms%3B%20(%24(%24depth)*)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<h3 id='入口' class='section-header'><a href='#入口'>入口</a></h3>
<p>这是唯一一条非内用规则。</p>

<p>需注意的一点是，由于此规则单纯地匹配*所有*提供的标记，它极其危险。任何错误输入，都将造成其上的内用规则匹配完全失败，进而又落至匹配它(成功)的后果；引发无尽递归。</p>

<p>当在写、改及调试此类宏的过程中，明智的做法是，在此类规则的匹配头部加上临时性前缀，比如给此例加上一个<code>@entry</code>；以防止无尽递归，并得到更加恰当有效的错误信息。</p>

<pre class='rust rust-example-rendered'>
    ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>Ooks</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>start</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>Ooks</span>)<span class='kw-2'>*</span>)
    };
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%24(%24Ooks%3Att)*)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40start%20%24(%24Ooks)*)%0A%20%20%20%20%7D%3B%0A%7D%0A%7D">Run</a></pre>

<h3 id='用例' class='section-header'><a href='#用例'>用例</a></h3>
<p>现在终于是时候上测试了。</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> _ <span class='op'>=</span> <span class='macro'>Ook</span><span class='macro'>!</span>(
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.
    );
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20let%20_%20%3D%20Ook!(%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook!%20Ook%3F%20%20Ook%3F%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%20%20Ook%3F%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook!%20Ook%3F%20%20Ook%3F%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook%3F%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%20%20Ook%3F%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook!%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook!%20Ook.%20%20Ook.%20Ook%3F%20%20Ook.%20Ook%3F%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook!%20Ook%3F%20%20Ook%3F%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook%3F%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%20%20Ook%3F%20Ook.%20%20Ook!%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook.%20Ook%3F%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook!%20Ook%3F%20%20Ook%3F%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%20%20Ook%3F%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook.%0A%20%20%20%20%20%20%20%20Ook%3F%20Ook.%20%20Ook%3F%20Ook.%20%20Ook%3F%20Ook.%20%20Ook%3F%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook.%20Ook%3F%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook!%20Ook%3F%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook!%20Ook.%0A%20%20%20%20)%3B%0A%7D%0A">Run</a></pre>

<p>运行(在编译器进行数百次递归宏展开而停顿相当长一段时间之后)的输出将是：</p>

<pre><code class="language-text">Hello World!
</code></pre>

<p>由此，我们揭示出了令人惊恐的真相：<code>macro_rules!</code>是图灵完备的！</p>

<h3 id='附注' class='section-header'><a href='#附注'>附注</a></h3>
<p>此文所基的宏，是一个名为“Hodor!”的同构语言实现。Manish Goregaokar后来<a href="https://www.reddit.com/r/rust/comments/39wvrm/hodor_esolang_as_a_rust_macro/cs76rqk?context=10000">用那个宏实现了一个Brainfuck的解析器</a>。也就是说，那个Brainfuck解析器用<code>Hodor!</code>宏写成，而后者本身则又是由<code>macro_rules!</code>实现的！</p>

<p>传说在把递归极限提至*三百万*，并让之编译了*四天*后，整个过程终于得以完成。</p>

<p>...收场的方式是栈溢出中止。时至今日，Rust宏驱动的密文编程语言仍然绝非可行的开发手段。</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>我们的确可以在宏内部定义这些，但那样一来它们就必须被显式的传来传去(由于宏的卫生性)。坦率地讲，当我意识到真的需要这些定义的时候，我的宏已经写得七七八八了...如果没有绝对的必要，你想跟我一样尝试修补那样的烂摊子吗？&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

<li id="fn2">
<p>一个鲜有人知的事实<sup id="fnref3"><a href="#fn3" rel="footnote">3</a></sup>是，金发姑娘的故事实际上是一则写给准确词法解析技术的寓言。&nbsp;<a href="#fnref2" rev="footnote">&#8617;</a></p>
</li>

<li id="fn3">
<p>这个“事实”实际上意思是“臭不要脸的谣言”。&nbsp;<a href="#fnref3" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

    <script src='rustbook.js'></script>
</div></div>


</body>
</html>