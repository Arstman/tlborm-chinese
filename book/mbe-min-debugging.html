<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>调试</title>

    <link rel="stylesheet" type="text/css" href="rustbook.css">

    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
                <div id="nav">
                    <button id="toggle-nav">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </button>
                </div>
<div id='toc' class='mobile-hidden'>
<ol class='chapter'>
<li><a  href='README.html'><b>1.</b> Introduction</a>
</li>
<li><a  href='mbe-README.html'><b>2.</b> 宏，彻底剖析</a>
<ol class='section'>
<li><a  href='mbe-syn-README.html'><b>2.1.</b> 语法扩展</a>
<ol class='section'>
<li><a  href='mbe-syn-source-analysis.html'><b>2.1.1.</b> 源码解析过程</a>
</li>
<li><a  href='mbe-syn-macros-in-the-ast.html'><b>2.1.2.</b> AST中的宏</a>
</li>
<li><a  href='mbe-syn-expansion.html'><b>2.1.3.</b> 展开</a>
</li>
</ol>
</li>
<li><a  href='mbe-macro-rules.html'><b>2.2.</b> macro_rules!</a>
</li>
<li><a  href='mbe-min-README.html'><b>2.3.</b> 细枝末节</a>
<ol class='section'>
<li><a  href='mbe-min-captures-and-expansion-redux.html'><b>2.3.1.</b> 再探捕获与展开</a>
</li>
<li><a  href='mbe-min-hygiene.html'><b>2.3.2.</b> 卫生性</a>
</li>
<li><a  href='mbe-min-non-identifier-identifiers.html'><b>2.3.3.</b> 不是标识符的标识符</a>
</li>
<li><a class='active' href='mbe-min-debugging.html'><b>2.3.4.</b> 调试</a>
</li>
<li><a  href='mbe-min-scoping.html'><b>2.3.5.</b> 作用域</a>
</li>
<li><a  href='mbe-min-import-export.html'><b>2.3.6.</b> 导入/导出</a>
</li>
</ol>
</li>
</ol>
</li>
<li><a  href='pim-README.html'><b>3.</b> 宏，实践介绍</a>
</li>
<li><a  href='pat-README.html'><b>4.</b> 常用模式</a>
<ol class='section'>
<li><a  href='pat-callbacks.html'><b>4.1.</b> 回调</a>
</li>
<li><a  href='pat-incremental-tt-munchers.html'><b>4.2.</b> 标记树撕咬机</a>
</li>
<li><a  href='pat-internal-rules.html'><b>4.3.</b> 内用规则</a>
</li>
<li><a  href='pat-push-down-accumulation.html'><b>4.4.</b> 下推累积</a>
</li>
<li><a  href='pat-repetition-replacement.html'><b>4.5.</b> 重复替代</a>
</li>
<li><a  href='pat-trailing-separators.html'><b>4.6.</b> 尾部分隔符</a>
</li>
<li><a  href='pat-tt-bundling.html'><b>4.7.</b> 标记树聚束</a>
</li>
<li><a  href='pat-visibility.html'><b>4.8.</b> 可见性</a>
</li>
<li><a  href='pat-provisional.html'><b>4.9.</b> 临时措施</a>
</li>
</ol>
</li>
<li><a  href='blk-README.html'><b>5.</b> 轮子</a>
<ol class='section'>
<li><a  href='blk-ast-coercion.html'><b>5.1.</b> AST强转</a>
</li>
<li><a  href='blk-counting.html'><b>5.2.</b> 计数</a>
</li>
<li><a  href='blk-enum-parsing.html'><b>5.3.</b> 枚举解析</a>
</li>
</ol>
</li>
<li><a  href='aeg-README.html'><b>6.</b> 实例注解</a>
<ol class='section'>
<li><a  href='aeg-ook.html'><b>6.1.</b> Ook!</a>
</li>
</ol>
</li>
</ol>
</div>
<div id='page-wrapper'>
<div id='page'>


    <h1 class="title">调试</h1>
    <p><code>rustc</code>提供了一些工具用来调试宏。其中，最有用的之一是<code>trace_macros!</code>。它会指示编译器，在每一个宏调用被展开之前将其转印出来。例如，给定下列代码：</p>

<pre class='rust rust-example-rendered'>
<span class='attribute'>#<span class='op'>!</span>[<span class='ident'>feature</span>(<span class='ident'>trace_macros</span>)]</span>

<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>each_tt</span> {
    () <span class='op'>=&gt;</span> {};
    (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>_tt</span>:<span class='ident'>tt</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>rest</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>=&gt;</span> {<span class='macro'>each_tt</span><span class='macro'>!</span>($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>rest</span>)<span class='kw-2'>*</span>);};
}

<span class='macro'>each_tt</span><span class='macro'>!</span>(<span class='ident'>foo</span> <span class='ident'>bar</span> <span class='ident'>baz</span> <span class='ident'>quux</span>);
<span class='macro'>trace_macros</span><span class='macro'>!</span>(<span class='bool-val'>true</span>);
<span class='macro'>each_tt</span><span class='macro'>!</span>(<span class='ident'>spim</span> <span class='ident'>wak</span> <span class='ident'>plee</span> <span class='ident'>whum</span>);
<span class='macro'>trace_macros</span><span class='macro'>!</span>(<span class='bool-val'>false</span>);
<span class='macro'>each_tt</span><span class='macro'>!</span>(<span class='ident'>trom</span> <span class='ident'>qlip</span> <span class='ident'>winp</span> <span class='ident'>xod</span>);<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%2F%2F%20Note%3A%20make%20sure%20to%20use%20a%20nightly%20channel%20compiler.%0A%23!%5Bfeature(trace_macros)%5D%0A%0Amacro_rules!%20each_tt%20%7B%0A%20%20%20%20()%20%3D%3E%20%7B%7D%3B%0A%20%20%20%20(%24_tt%3Att%20%24(%24rest%3Att)*)%20%3D%3E%20%7Beach_tt!(%24(%24rest)*)%3B%7D%3B%0A%7D%0A%0Aeach_tt!(foo%20bar%20baz%20quux)%3B%0Atrace_macros!(true)%3B%0Aeach_tt!(spim%20wak%20plee%20whum)%3B%0Atrace_macros!(false)%3B%0Aeach_tt!(trom%20qlip%20winp%20xod)%3B%0A%0Afn%20main()%20%7B%7D%0A&amp;version=nightly">Run</a></pre>

<p>编译输出将包含：</p>

<pre><code class="language-text">each_tt! { spim wak plee whum }
each_tt! { wak plee whum }
each_tt! { plee whum }
each_tt! { whum }
each_tt! {  }
</code></pre>

<p>它在调试递归很深的宏时尤其有用。同时，它可以在命令提示符中被打开，在编译指令中附加<code>-Z trace-macros</code>即可。</p>

<p>另一有用的宏是<code>log_syntax!</code>。它将使得编译器输出所有经过编译器处理的标记。举个例子，下述代码可以让编译器唱一首歌：</p>

<pre class='rust rust-example-rendered'>
<span class='attribute'>#<span class='op'>!</span>[<span class='ident'>feature</span>(<span class='ident'>log_syntax</span>)]</span>

<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>sing</span> {
    () <span class='op'>=&gt;</span> {};
    (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tt</span>:<span class='ident'>tt</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>rest</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>=&gt;</span> {<span class='macro'>log_syntax</span><span class='macro'>!</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tt</span>); <span class='macro'>sing</span><span class='macro'>!</span>($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>rest</span>)<span class='kw-2'>*</span>);};
}

<span class='macro'>sing</span><span class='macro'>!</span> {
    <span class='op'>^</span> <span class='op'>&lt;</span> @ <span class='op'>&lt;</span> . @ <span class='op'>*</span>
    <span class='string'>&#39;\x08&#39;</span> <span class='string'>&#39;{&#39;</span> <span class='string'>&#39;&quot;&#39;</span> _ <span class='attribute'># <span class='string'>&#39; &#39;</span>
    <span class='op'>-</span> @ <span class='string'>&#39;$&#39;</span> <span class='op'>&amp;&amp;</span> <span class='op'>/</span> _ <span class='op'>%</span>
    <span class='op'>!</span> ( <span class='string'>&#39;\t&#39;</span> @ <span class='op'>|</span> <span class='op'>=</span> <span class='op'>&gt;</span>
    ; <span class='string'>&#39;\x08&#39;</span> <span class='string'>&#39;\&#39;&#39;</span> <span class='op'>+</span> <span class='string'>&#39;$&#39;</span> <span class='question-mark'>?</span> <span class='string'>&#39;\x7f&#39;</span>
    , <span class='attribute'># <span class='string'>&#39;&quot;&#39;</span> ~ <span class='op'>|</span> ) <span class='string'>&#39;\x07&#39;</span>
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%2F%2F%20Note%3A%20make%20sure%20to%20use%20a%20nightly%20channel%20compiler.%0A%23!%5Bfeature(log_syntax)%5D%0A%0Amacro_rules!%20sing%20%7B%0A%20%20%20%20()%20%3D%3E%20%7B%7D%3B%0A%20%20%20%20(%24tt%3Att%20%24(%24rest%3Att)*)%20%3D%3E%20%7Blog_syntax!(%24tt)%3B%20sing!(%24(%24rest)*)%3B%7D%3B%0A%7D%0A%0Asing!%20%7B%0A%20%20%20%20%5E%20%3C%20%40%20%3C%20.%20%40%20*%0A%20%20%20%20'%5Cx08'%20'%7B'%20'%22'%20_%20%23%20'%20'%0A%20%20%20%20-%20%40%20'%24'%20%26%26%20%2F%20_%20%25%0A%20%20%20%20!%20(%20'%5Ct'%20%40%20%7C%20%3D%20%3E%0A%20%20%20%20%3B%20'%5Cx08'%20'%5C''%20%2B%20'%24'%20%3F%20'%5Cx7f'%0A%20%20%20%20%2C%20%23%20'%22'%20~%20%7C%20)%20'%5Cx07'%0A%7D%0A%0Afn%20main()%20%7B%7D%0A&amp;version=nightly">Run</a></pre>

<p>比起<code>trace_macros!</code>来说，它能够做一些更有针对性的调试。</p>

<p>有时问题出在宏展开后的结果里。对于这种情况，可用编译命令<code>--pretty</code>来勘察。给出下列代码：</p>

<pre class='rust rust-example-rendered'>
<span class='comment'>// Shorthand for initialising a `String`.</span>
<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>S</span> {
    (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>e</span>:<span class='ident'>expr</span>) <span class='op'>=&gt;</span> {<span class='ident'>String</span>::<span class='ident'>from</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>e</span>)};
}

<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>world</span> <span class='op'>=</span> <span class='macro'>S</span><span class='macro'>!</span>(<span class='string'>&quot;World&quot;</span>);
    <span class='macro'>println</span><span class='macro'>!</span>(<span class='string'>&quot;Hello, {}!&quot;</span>, <span class='ident'>world</span>);
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%2F%2F%20Shorthand%20for%20initialising%20a%20%60String%60.%0Amacro_rules!%20S%20%7B%0A%20%20%20%20(%24e%3Aexpr)%20%3D%3E%20%7BString%3A%3Afrom(%24e)%7D%3B%0A%7D%0A%0Afn%20main()%20%7B%0A%20%20%20%20let%20world%20%3D%20S!(%22World%22)%3B%0A%20%20%20%20println!(%22Hello%2C%20%7B%7D!%22%2C%20world)%3B%0A%7D%0A">Run</a></pre>

<p>并用如下编译命令进行编译，</p>

<pre><code class="language-shell">rustc -Z unstable-options --pretty expanded hello.rs
</code></pre>

<p>将输出如下内容(略经修改以符合排版)：</p>

<pre class='rust rust-example-rendered'>
<span class='attribute'>#<span class='op'>!</span>[<span class='ident'>feature</span>(<span class='ident'>no_std</span>, <span class='ident'>prelude_import</span>)]</span>
<span class='attribute'>#<span class='op'>!</span>[<span class='ident'>no_std</span>]</span>
<span class='attribute'>#[<span class='ident'>prelude_import</span>]</span>
<span class='kw'>use</span> <span class='ident'>std</span>::<span class='ident'>prelude</span>::<span class='ident'>v1</span>::<span class='kw-2'>*</span>;
<span class='attribute'>#[<span class='ident'>macro_use</span>]</span>
<span class='kw'>extern</span> <span class='kw'>crate</span> <span class='ident'>std</span> <span class='kw'>as</span> <span class='ident'>std</span>;
<span class='comment'>// Shorthand for initialising a `String`.</span>
<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> <span class='ident'>world</span> <span class='op'>=</span> <span class='ident'>String</span>::<span class='ident'>from</span>(<span class='string'>&quot;World&quot;</span>);
    ::<span class='ident'>std</span>::<span class='ident'>io</span>::<span class='ident'>_print</span>(::<span class='ident'>std</span>::<span class='ident'>fmt</span>::<span class='ident'>Arguments</span>::<span class='ident'>new_v1</span>(
        {
            <span class='kw'>static</span> <span class='ident'>__STATIC_FMTSTR</span>: <span class='kw-2'>&amp;</span><span class='lifetime'>&#39;static</span> [<span class='kw-2'>&amp;</span><span class='lifetime'>&#39;static</span> <span class='ident'>str</span>]
                <span class='op'>=</span> <span class='kw-2'>&amp;</span>[<span class='string'>&quot;Hello, &quot;</span>, <span class='string'>&quot;!\n&quot;</span>];
            <span class='ident'>__STATIC_FMTSTR</span>
        },
        <span class='kw-2'>&amp;</span><span class='kw'>match</span> (<span class='kw-2'>&amp;</span><span class='ident'>world</span>,) {
             (<span class='ident'>__arg0</span>,) <span class='op'>=&gt;</span> [
                ::<span class='ident'>std</span>::<span class='ident'>fmt</span>::<span class='ident'>ArgumentV1</span>::<span class='ident'>new</span>(<span class='ident'>__arg0</span>, ::<span class='ident'>std</span>::<span class='ident'>fmt</span>::<span class='ident'>Display</span>::<span class='ident'>fmt</span>)
            ],
        }
    ));
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=%23!%5Bfeature(no_std%2C%20prelude_import)%5D%0A%23!%5Bno_std%5D%0A%23%5Bprelude_import%5D%0Ause%20std%3A%3Aprelude%3A%3Av1%3A%3A*%3B%0A%23%5Bmacro_use%5D%0Aextern%20crate%20std%20as%20std%3B%0A%2F%2F%20Shorthand%20for%20initialising%20a%20%60String%60.%0Afn%20main()%20%7B%0A%20%20%20%20let%20world%20%3D%20String%3A%3Afrom(%22World%22)%3B%0A%20%20%20%20%3A%3Astd%3A%3Aio%3A%3A_print(%3A%3Astd%3A%3Afmt%3A%3AArguments%3A%3Anew_v1(%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20static%20__STATIC_FMTSTR%3A%20%26'static%20%5B%26'static%20str%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3D%20%26%5B%22Hello%2C%20%22%2C%20%22!%5Cn%22%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20__STATIC_FMTSTR%0A%20%20%20%20%20%20%20%20%7D%2C%0A%20%20%20%20%20%20%20%20%26match%20(%26world%2C)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20(__arg0%2C)%20%3D%3E%20%5B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3A%3Astd%3A%3Afmt%3A%3AArgumentV1%3A%3Anew(__arg0%2C%20%3A%3Astd%3A%3Afmt%3A%3ADisplay%3A%3Afmt)%0A%20%20%20%20%20%20%20%20%20%20%20%20%5D%2C%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20))%3B%0A%7D%0A&amp;version=nightly">Run</a></pre>

<p><code>--pretty</code>还有其它一些可用选项，可通过<code>rustc -Z unstable-options --help -v</code>来列出。此处并不提供该选项表；因为，正如指令本身所暗示的，表中的一切内容在任何时间点都有可能发生改变。</p>

    <script src='rustbook.js'></script>
</div></div>


</body>
</html>