<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="rustdoc">
    <title>Ook!</title>

    <link rel="stylesheet" type="text/css" href="rustbook.css">

    
</head>
<body class="rustdoc">
    <!--[if lte IE 8]>
    <div class="warning">
        This old browser is unsupported and will most likely display funky
        things.
    </div>
    <![endif]-->

    
                <div id="nav">
                    <button id="toggle-nav">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                        <span class="bar"></span>
                    </button>
                </div>
<div id='toc' class='mobile-hidden'>
<ol class='chapter'>
<li><a  href='README.html'><b>1.</b> Introduction</a>
</li>
<li><a  href='mbe-README.html'><b>2.</b> 宏，彻底剖析</a>
<ol class='section'>
<li><a  href='mbe-syn-README.html'><b>2.1.</b> 语法扩展</a>
<ol class='section'>
<li><a  href='mbe-syn-source-analysis.html'><b>2.1.1.</b> 源码解析过程</a>
</li>
<li><a  href='mbe-syn-macros-in-the-ast.html'><b>2.1.2.</b> AST中的宏</a>
</li>
<li><a  href='mbe-syn-expansion.html'><b>2.1.3.</b> 展开</a>
</li>
</ol>
</li>
<li><a  href='mbe-macro-rules.html'><b>2.2.</b> macro_rules!</a>
</li>
<li><a  href='mbe-min-README.html'><b>2.3.</b> 细枝末节</a>
<ol class='section'>
<li><a  href='mbe-min-captures-and-expansion-redux.html'><b>2.3.1.</b> 再探捕获与展开</a>
</li>
<li><a  href='mbe-min-hygiene.html'><b>2.3.2.</b> 卫生性</a>
</li>
<li><a  href='mbe-min-non-identifier-identifiers.html'><b>2.3.3.</b> 不是标识符的标识符</a>
</li>
<li><a  href='mbe-min-debugging.html'><b>2.3.4.</b> 调试</a>
</li>
<li><a  href='mbe-min-scoping.html'><b>2.3.5.</b> 作用域</a>
</li>
<li><a  href='mbe-min-import-export.html'><b>2.3.6.</b> 导入/导出</a>
</li>
</ol>
</li>
</ol>
</li>
<li><a  href='pim-README.html'><b>3.</b> 宏，实践介绍</a>
</li>
<li><a  href='pat-README.html'><b>4.</b> Patterns</a>
<ol class='section'>
<li><a  href='pat-callbacks.html'><b>4.1.</b> Callbacks</a>
</li>
<li><a  href='pat-incremental-tt-munchers.html'><b>4.2.</b> Incremental TT Munchers</a>
</li>
<li><a  href='pat-internal-rules.html'><b>4.3.</b> Internal Rules</a>
</li>
<li><a  href='pat-push-down-accumulation.html'><b>4.4.</b> Push-Down Accumulation</a>
</li>
<li><a  href='pat-repetition-replacement.html'><b>4.5.</b> Repetition Replacement</a>
</li>
<li><a  href='pat-trailing-separators.html'><b>4.6.</b> Trailing Separators</a>
</li>
<li><a  href='pat-tt-bundling.html'><b>4.7.</b> TT Bundling</a>
</li>
<li><a  href='pat-visibility.html'><b>4.8.</b> Visibility</a>
</li>
<li><a  href='pat-provisional.html'><b>4.9.</b> Provisional</a>
</li>
</ol>
</li>
<li><a  href='blk-README.html'><b>5.</b> Building Blocks</a>
<ol class='section'>
<li><a  href='blk-ast-coercion.html'><b>5.1.</b> AST Coercion</a>
</li>
<li><a  href='blk-counting.html'><b>5.2.</b> Counting</a>
</li>
<li><a  href='blk-enum-parsing.html'><b>5.3.</b> Enum Parsing</a>
</li>
</ol>
</li>
<li><a  href='aeg-README.html'><b>6.</b> Annotated Examples</a>
<ol class='section'>
<li><a class='active' href='aeg-ook.html'><b>6.1.</b> Ook!</a>
</li>
</ol>
</li>
</ol>
</div>
<div id='page-wrapper'>
<div id='page'>


    <h1 class="title">Ook!</h1>
    <p>This macro is an implementation of the <a href="http://www.dangermouse.net/esoteric/ook.html">Ook! esoteric language</a>, which is isomorphic to the <a href="http://www.muppetlabs.com/%7Ebreadbox/bf/">Brainfuck esoteric language</a>.</p>

<p>The execution model for the language is very simple: memory is represented as an array of &quot;cells&quot; (typically at least 8-bits) of some indeterminate number (usually at least 30,000).  There is a pointer into memory which starts off at position 0.  Finally, there is an execution stack (used to implement looping) and pointer into the program, although these last two are not exposed to the running program; they are properties of the runtime itself.</p>

<p>The language itself is comprised of just three tokens: <code>Ook.</code>, <code>Ook?</code>, and <code>Ook!</code>.  These are combined in pairs to form the eight different operations:</p>

<ul>
<li><code>Ook. Ook?</code> - increment pointer.</li>
<li><code>Ook? Ook.</code> - decrement pointer.</li>
<li><code>Ook. Ook.</code> - increment pointed-to memory cell.</li>
<li><code>Ook! Ook!</code> - decrement pointed-to memory cell.</li>
<li><code>Ook! Ook.</code> - write pointed-to memory cell to standard output.</li>
<li><code>Ook. Ook!</code> - read from standard input into pointed-to memory cell.</li>
<li><code>Ook! Ook?</code> - begin a loop.</li>
<li><code>Ook? Ook!</code> - jump back to start of loop if pointed-to memory cell is not zero; otherwise, continue.</li>
</ul>

<p>Ook! is interesting because it is known to be Turing-complete, meaning that any environment in which you can implement it must <em>also</em> be Turing-complete.</p>

<h2 id='implementation' class='section-header'><a href='#implementation'>Implementation</a></h2>
<pre class='rust rust-example-rendered'>
<span class='attribute'>#<span class='op'>!</span>[<span class='ident'>recursion_limit</span> <span class='op'>=</span> <span class='string'>&quot;158&quot;</span>]</span><a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%23!%5Brecursion_limit%20%3D%20%22158%22%5D%0A%7D">Run</a></pre>

<p>This is, in fact, the lowest possible recursion limit for which the example program provided at the end will actually compile.  If you&#39;re wondering what could be so fantastically complex that it would <em>justify</em> a recursion limit nearly five times the default limit... <a href="https://en.wikipedia.org/wiki/Hello_world_program">take a wild guess</a>.</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>type</span> <span class='ident'>CellType</span> <span class='op'>=</span> <span class='ident'>u8</span>;
<span class='kw'>const</span> <span class='ident'>MEM_SIZE</span>: <span class='ident'>usize</span> <span class='op'>=</span> <span class='number'>30_000</span>;<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Atype%20CellType%20%3D%20u8%3B%0Aconst%20MEM_SIZE%3A%20usize%20%3D%2030_000%3B%0A%7D">Run</a></pre>

<p>These are here purely to ensure they are visible to the macro expansion.<sup id="fnref1"><a href="#fn1" rel="footnote">1</a></sup></p>

<pre class='rust rust-example-rendered'>
<span class='macro'>macro_rules</span><span class='macro'>!</span> <span class='ident'>Ook</span> {<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Amacro_rules!%20Ook%20%7B%0A%7D">Run</a></pre>

<p>The name should <em>probably</em> have been <code>ook!</code> to match the standard naming convention, but the opportunity was simply too good to pass up.</p>

<p>The rules for this macro are broken up into sections using the <a href="../pat/README.html#internal-rules">internal rules</a> pattern.</p>

<p>The first of these will be a <code>@start</code> rule, which takes care of setting up the block in which the rest of our expansion will happen.  There is nothing particularly interesting in this: we define some variables and helper functions, then do the bulk of the expansion.</p>

<p>A few small notes:</p>

<ul>
<li>We are expanding into a function largely so that we can use <code>try!</code> to simplify error handling.</li>
<li>The use of underscore-prefixed names is so that the compiler will not complain about unused functions or variables if, for example, the user writes an Ook! program that does no I/O.</li>
</ul>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>start</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>Ooks</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>=&gt;</span> {
        {
            <span class='kw'>fn</span> <span class='ident'>ook</span>() <span class='op'>-&gt;</span> ::<span class='ident'>std</span>::<span class='ident'>io</span>::<span class='prelude-ty'>Result</span><span class='op'>&lt;</span><span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>CellType</span><span class='op'>&gt;&gt;</span> {
                <span class='kw'>use</span> ::<span class='ident'>std</span>::<span class='ident'>io</span>;
                <span class='kw'>use</span> ::<span class='ident'>std</span>::<span class='ident'>io</span>::<span class='ident'>prelude</span>::<span class='kw-2'>*</span>;
    
                <span class='kw'>fn</span> <span class='ident'>_re</span>() <span class='op'>-&gt;</span> <span class='ident'>io</span>::<span class='ident'>Error</span> {
                    <span class='ident'>io</span>::<span class='ident'>Error</span>::<span class='ident'>new</span>(
                        <span class='ident'>io</span>::<span class='ident'>ErrorKind</span>::<span class='ident'>Other</span>,
                        <span class='ident'>String</span>::<span class='ident'>from</span>(<span class='string'>&quot;ran out of input&quot;</span>))
                }
                
                <span class='kw'>fn</span> <span class='ident'>_inc</span>(<span class='ident'>a</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> [<span class='ident'>u8</span>], <span class='ident'>i</span>: <span class='ident'>usize</span>) {
                    <span class='kw'>let</span> <span class='ident'>c</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>a</span>[<span class='ident'>i</span>];
                    <span class='kw-2'>*</span><span class='ident'>c</span> <span class='op'>=</span> <span class='ident'>c</span>.<span class='ident'>wrapping_add</span>(<span class='number'>1</span>);
                }
                
                <span class='kw'>fn</span> <span class='ident'>_dec</span>(<span class='ident'>a</span>: <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> [<span class='ident'>u8</span>], <span class='ident'>i</span>: <span class='ident'>usize</span>) {
                    <span class='kw'>let</span> <span class='ident'>c</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>a</span>[<span class='ident'>i</span>];
                    <span class='kw-2'>*</span><span class='ident'>c</span> <span class='op'>=</span> <span class='ident'>c</span>.<span class='ident'>wrapping_sub</span>(<span class='number'>1</span>);
                }
    
                <span class='kw'>let</span> <span class='ident'>_r</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>io</span>::<span class='ident'>stdin</span>();
                <span class='kw'>let</span> <span class='ident'>_w</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='ident'>io</span>::<span class='ident'>stdout</span>();
        
                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>_a</span>: <span class='ident'>Vec</span><span class='op'>&lt;</span><span class='ident'>CellType</span><span class='op'>&gt;</span> <span class='op'>=</span> <span class='ident'>Vec</span>::<span class='ident'>with_capacity</span>(<span class='ident'>MEM_SIZE</span>);
                <span class='ident'>_a</span>.<span class='ident'>extend</span>(::<span class='ident'>std</span>::<span class='ident'>iter</span>::<span class='ident'>repeat</span>(<span class='number'>0</span>).<span class='ident'>take</span>(<span class='ident'>MEM_SIZE</span>));
                <span class='kw'>let</span> <span class='kw-2'>mut</span> <span class='ident'>_i</span> <span class='op'>=</span> <span class='number'>0</span>;
                {
                    <span class='kw'>let</span> <span class='ident'>_a</span> <span class='op'>=</span> <span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='kw-2'>*</span><span class='ident'>_a</span>;
                    <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='ident'>_a</span>, <span class='ident'>_i</span>, <span class='ident'>_inc</span>, <span class='ident'>_dec</span>, <span class='ident'>_r</span>, <span class='ident'>_w</span>, <span class='ident'>_re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>Ooks</span>)<span class='kw-2'>*</span>));
                }
                <span class='prelude-val'>Ok</span>(<span class='ident'>_a</span>)
            }
            <span class='ident'>ook</span>()
        }
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40start%20%24(%24Ooks%3Att)*)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20fn%20ook()%20-%3E%20%3A%3Astd%3A%3Aio%3A%3AResult%3CVec%3CCellType%3E%3E%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20use%20%3A%3Astd%3A%3Aio%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20use%20%3A%3Astd%3A%3Aio%3A%3Aprelude%3A%3A*%3B%0A%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fn%20_re()%20-%3E%20io%3A%3AError%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20io%3A%3AError%3A%3Anew(%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20io%3A%3AErrorKind%3A%3AOther%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20String%3A%3Afrom(%22ran%20out%20of%20input%22))%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fn%20_inc(a%3A%20%26mut%20%5Bu8%5D%2C%20i%3A%20usize)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20c%20%3D%20%26mut%20a%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20*c%20%3D%20c.wrapping_add(1)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20fn%20_dec(a%3A%20%26mut%20%5Bu8%5D%2C%20i%3A%20usize)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20c%20%3D%20%26mut%20a%5Bi%5D%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20*c%20%3D%20c.wrapping_sub(1)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20_r%20%3D%20%26mut%20io%3A%3Astdin()%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20_w%20%3D%20%26mut%20io%3A%3Astdout()%3B%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20mut%20_a%3A%20Vec%3CCellType%3E%20%3D%20Vec%3A%3Awith_capacity(MEM_SIZE)%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20_a.extend(%3A%3Astd%3A%3Aiter%3A%3Arepeat(0).take(MEM_SIZE))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20mut%20_i%20%3D%200%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20let%20_a%20%3D%20%26mut%20*_a%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Ook!(%40e%20(_a%2C%20_i%2C%20_inc%2C%20_dec%2C%20_r%2C%20_w%2C%20_re)%3B%20(%24(%24Ooks)*))%3B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Ok(_a)%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20%20%20%20%20ook()%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<h3 id='opcode-parsing' class='section-header'><a href='#opcode-parsing'>Opcode parsing</a></h3>
<p>Next are the &quot;execute&quot; rules, which are used to parse opcodes from the input.</p>

<p>The general form of these rules is <code>(@e $syms; ($input))</code>.  As you can see from the <code>@start</code> rule, <code>$syms</code> is the collection of symbols needed to actually implement the program: input, output, the memory array, <em>etc.</em>.  We are using <a href="../pat/README.html#tt-bundling">TT bundling</a> to simplify forwarding of these symbols through later, intermediate rules.</p>

<p>First, is the rule that terminates our recursion: once we have no more input, we stop.</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>e</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ()) <span class='op'>=&gt;</span> {};<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40e%20%24syms%3Att%3B%20())%20%3D%3E%20%7B%7D%3B%0A%7D">Run</a></pre>

<p>Next, we have a single rule for <em>almost</em> each opcode.  For these, we strip off the opcode, emit the corresponding Rust code, then recurse on the input tail: a textbook <a href="../pat/README.html#incremental-tt-munchers">TT muncher</a>.</p>

<pre class='rust rust-example-rendered'>
    <span class='comment'>// Increment pointer.</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> <span class='op'>=</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> <span class='op'>+</span> <span class='number'>1</span>) <span class='op'>%</span> <span class='ident'>MEM_SIZE</span>;
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// Decrement pointer.</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>. $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> <span class='op'>=</span> <span class='kw'>if</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> <span class='op'>==</span> <span class='number'>0</span> { <span class='ident'>MEM_SIZE</span> } <span class='kw'>else</span> { <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> } <span class='op'>-</span> <span class='number'>1</span>;
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// Increment pointee.</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='ident'>Ook</span>. <span class='ident'>Ook</span>. $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>);
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// Decrement pointee.</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>);
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// Write to stdout.</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>. $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>try</span><span class='macro'>!</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>.<span class='ident'>write_all</span>(<span class='kw-2'>&amp;</span><span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>[<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> .. <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span><span class='op'>+</span><span class='number'>1</span>]));
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// Read from stdin.</span>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='ident'>Ook</span>. <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>try</span><span class='macro'>!</span>(
            <span class='kw'>match</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>.<span class='ident'>read</span>(<span class='kw-2'>&amp;</span><span class='kw-2'>mut</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>[<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span> .. <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span><span class='op'>+</span><span class='number'>1</span>]) {
                <span class='prelude-val'>Ok</span>(<span class='number'>0</span>) <span class='op'>=&gt;</span> <span class='prelude-val'>Err</span>(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>()),
                <span class='ident'>ok</span> @ <span class='prelude-val'>Ok</span>(..) <span class='op'>=&gt;</span> <span class='ident'>ok</span>,
                <span class='ident'>err</span> @ <span class='prelude-val'>Err</span>(..) <span class='op'>=&gt;</span> <span class='ident'>err</span>
            }
        );
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20%2F%2F%20Increment%20pointer.%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook.%20Ook%3F%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%24i%20%3D%20(%24i%20%2B%201)%20%25%20MEM_SIZE%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Decrement%20pointer.%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook.%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%24i%20%3D%20if%20%24i%20%3D%3D%200%20%7B%20MEM_SIZE%20%7D%20else%20%7B%20%24i%20%7D%20-%201%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Increment%20pointee.%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook.%20Ook.%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%24inc(%24a%2C%20%24i)%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Decrement%20pointee.%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%24dec(%24a%2C%20%24i)%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Write%20to%20stdout.%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook.%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20try!(%24w.write_all(%26%24a%5B%24i%20..%20%24i%2B1%5D))%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Read%20from%20stdin.%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook.%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20try!(%0A%20%20%20%20%20%20%20%20%20%20%20%20match%20%24r.read(%26mut%20%24a%5B%24i%20..%20%24i%2B1%5D)%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20Ok(0)%20%3D%3E%20Err(%24re())%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20ok%20%40%20Ok(..)%20%3D%3E%20ok%2C%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20err%20%40%20Err(..)%20%3D%3E%20err%0A%20%20%20%20%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20)%3B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<p>Here is where things get more complicated.  This opcode, <code>Ook! Ook?</code>, marks the start of a loop.  Ook! loops are translated to the following Rust code:</p>

<blockquote>
<p><strong>Note</strong>: this is <em>not</em> part of the larger code.</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>while</span> <span class='ident'>memory</span>[<span class='ident'>ptr</span>] <span class='op'>!=</span> <span class='number'>0</span> {
    <span class='comment'>// Contents of loop</span>
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0Awhile%20memory%5Bptr%5D%20!%3D%200%20%7B%0A%20%20%20%20%2F%2F%20Contents%20of%20loop%0A%7D%0A%7D">Run</a></pre>
</blockquote>

<p>Of course, we cannot <em>actually</em> emit an incomplete loop.  This <em>could</em> be solved by using <a href="../pat/README.html#push-down-accumulation">pushdown</a>, were it not for a more fundamental problem: we cannot <em>write</em> <code>while memory[ptr] != {</code>, at all, <em>anywhere</em>.  This is because doing so would introduce an unbalanced brace.</p>

<p>The solution to this is to actually split the input into two parts: everything <em>inside</em> the loop, and everything <em>after</em> it.  The <code>@x</code> rules handle the first, <code>@s</code> the latter.</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>e</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>:<span class='ident'>expr</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>:<span class='ident'>expr</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='kw'>while</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>[<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>] <span class='op'>!=</span> <span class='number'>0</span> {
            <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>x</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); (); (); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
        }
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>s</span> (<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>a</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>i</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>inc</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>dec</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>r</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>w</span>, <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>re</span>); (); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40e%20(%24a%3Aexpr%2C%20%24i%3Aexpr%2C%20%24inc%3Aexpr%2C%20%24dec%3Aexpr%2C%20%24r%3Aexpr%2C%20%24w%3Aexpr%2C%20%24re%3Aexpr)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook%3F%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20while%20%24a%5B%24i%5D%20!%3D%200%20%7B%0A%20%20%20%20%20%20%20%20%20%20%20%20Ook!(%40x%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20()%3B%20()%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%20%20%20%20%7D%0A%20%20%20%20%20%20%20%20Ook!(%40s%20(%24a%2C%20%24i%2C%20%24inc%2C%20%24dec%2C%20%24r%2C%20%24w%2C%20%24re)%3B%20()%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<h3 id='loop-extraction' class='section-header'><a href='#loop-extraction'>Loop extraction</a></h3>
<p>Next are the <code>@x</code>, or &quot;extraction&quot;, rules.  These are responsible for taking an input tail and extracting the contents of a loop.  The general form of these rules is: <code>(@x $sym; $depth; $buf; $tail)</code>.</p>

<p>The purpose of <code>$sym</code> is the same as above.  <code>$tail</code> is the input to be parsed, whilst <code>$buf</code> is a <a href="../pat/README.html#push-down-accumulation">push-down accumulation buffer</a> into which we will collect the opcodes that are inside the loop.  But what of <code>$depth</code>?</p>

<p>A complication to all this is that loops can be <em>nested</em>.  Thus, we must have some way of keeping track of how many levels deep we currently are.  We must track this accurately enough to not stop parsing too early, nor too late, but when the level is <em>just right</em>.<sup id="fnref2"><a href="#fn2" rel="footnote">2</a></sup></p>

<p>Since we cannot do arithmetic in macros, and it would be infeasible to write out explicit integer-matching rules (imagine the following rules all copy &amp; pasted for a non-trivial number of positive integers), we will instead fall back on one of the most ancient and venerable counting methods in history: counting on our fingers.</p>

<p>But as macros don&#39;t <em>have</em> fingers, we&#39;ll use a <a href="../pat/README.html#abacus-counters">token abacus counter</a> instead.  Specifically, we will use <code>@</code>s, where each <code>@</code> represents one additional level of depth.  If we keep these <code>@</code>s contained in a group, we can implement the three important operations we need:</p>

<ul>
<li>Increment: match <code>($($depth:tt)*)</code>, substitute <code>(@ $($depth)*)</code>.</li>
<li>Decrement: match <code>(@ $($depth:tt)*)</code>, substitute <code>($($depth)*)</code>.</li>
<li>Compare to zero: match <code>()</code>.</li>
</ul>

<p>First is a rule to detect when we find the matching <code>Ook? Ook!</code> sequence that closes the loop we&#39;re parsing.  In this case, we feed the accumulated loop contents to the previously defined <code>@e</code> rules.</p>

<p>Note that we <em>do not</em> need to do anything with the remaining input tail (that will be handled by the <code>@s</code> rules).</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; (); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='comment'>// Outer-most loop is closed.  Process the buffered tokens.</span>
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40x%20%24syms%3Att%3B%20()%3B%20(%24(%24buf%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20Outer-most%20loop%20is%20closed.%20%20Process%20the%20buffered%20tokens.%0A%20%20%20%20%20%20%20%20Ook!(%40e%20%24syms%3B%20(%24(%24buf)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<p>Next, we have rules for entering and exiting nested loops.  These adjust the counter and add the opcodes to the buffer.</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='comment'>// One level deeper.</span>
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; (@ $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>)<span class='op'>*</span> <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    (@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; (@ $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='comment'>// One level higher.</span>
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>)<span class='op'>*</span> <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40x%20%24syms%3Att%3B%20(%24(%24depth%3Att)*)%3B%20(%24(%24buf%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook%3F%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20One%20level%20deeper.%0A%20%20%20%20%20%20%20%20Ook!(%40x%20%24syms%3B%20(%40%20%24(%24depth)*)%3B%20(%24(%24buf)*%20Ook!%20Ook%3F)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20(%40x%20%24syms%3Att%3B%20(%40%20%24(%24depth%3Att)*)%3B%20(%24(%24buf%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20%2F%2F%20One%20level%20higher.%0A%20%20%20%20%20%20%20%20Ook!(%40x%20%24syms%3B%20(%24(%24depth)*)%3B%20(%24(%24buf)*%20Ook%3F%20Ook!)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<p>Finally, we have a rule for &quot;everything else&quot;.  Note the <code>$op0</code> and <code>$op1</code> captures: as far as Rust is concerned, our Ook! tokens are always <em>two</em> Rust tokens: the identifier <code>Ook</code>, and another token.  Thus, we can generalise over all non-loop opcodes by matching <code>!</code>, <code>?</code>, and <code>.</code> as <code>tt</code>s.</p>

<p>Here, we leave <code>$depth</code> untouched and just add the opcodes to the buffer.</p>

<pre class='rust rust-example-rendered'>
    (@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op0</span>:<span class='ident'>tt</span> <span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op1</span>:<span class='ident'>tt</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>x</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>buf</span>)<span class='op'>*</span> <span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op0</span> <span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op1</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%40x%20%24syms%3Att%3B%20%24depth%3Att%3B%20(%24(%24buf%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%20%24op0%3Att%20Ook%20%24op1%3Att%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40x%20%24syms%3B%20%24depth%3B%20(%24(%24buf)*%20Ook%20%24op0%20Ook%20%24op1)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<h3 id='loop-skipping' class='section-header'><a href='#loop-skipping'>Loop Skipping</a></h3>
<p>This is <em>broadly</em> the same as loop extraction, except we don&#39;t care about the <em>contents</em> of the loop (and as such, don&#39;t need the accumulation buffer).  All we need to know is when we are <em>past</em> the loop.  At that point, we resume processing the input using the <code>@e</code> rules.</p>

<p>As such, these rules are presented without further exposition.</p>

<pre class='rust rust-example-rendered'>
    <span class='comment'>// End of loop.</span>
    (@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ();
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>e</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };

    <span class='comment'>// Enter nested loop.</span>
    (@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; (@ $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };
    
    <span class='comment'>// Exit nested loop.</span>
    (@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; (@ $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };

    <span class='comment'>// Not a loop opcode.</span>
    (@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>:<span class='ident'>tt</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>);
        (<span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op0</span>:<span class='ident'>tt</span> <span class='ident'>Ook</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>op1</span>:<span class='ident'>tt</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>))
    <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>s</span> <span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>syms</span>; ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>depth</span>)<span class='kw-2'>*</span>); ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>tail</span>)<span class='kw-2'>*</span>));
    };<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20%2F%2F%20End%20of%20loop.%0A%20%20%20%20(%40s%20%24syms%3Att%3B%20()%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40e%20%24syms%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20%2F%2F%20Enter%20nested%20loop.%0A%20%20%20%20(%40s%20%24syms%3Att%3B%20(%24(%24depth%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook!%20Ook%3F%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40s%20%24syms%3B%20(%40%20%24(%24depth)*)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%20%20%20%20%0A%20%20%20%20%2F%2F%20Exit%20nested%20loop.%0A%20%20%20%20(%40s%20%24syms%3Att%3B%20(%40%20%24(%24depth%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%3F%20Ook!%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40s%20%24syms%3B%20(%24(%24depth)*)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%0A%20%20%20%20%2F%2F%20Not%20a%20loop%20opcode.%0A%20%20%20%20(%40s%20%24syms%3Att%3B%20(%24(%24depth%3Att)*)%3B%0A%20%20%20%20%20%20%20%20(Ook%20%24op0%3Att%20Ook%20%24op1%3Att%20%24(%24tail%3Att)*))%0A%20%20%20%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40s%20%24syms%3B%20(%24(%24depth)*)%3B%20(%24(%24tail)*))%3B%0A%20%20%20%20%7D%3B%0A%7D">Run</a></pre>

<h3 id='entry-point' class='section-header'><a href='#entry-point'>Entry point</a></h3>
<p>This is the only non-internal rule.</p>

<p>It is worth noting that because this formulation simply matches <em>all</em> tokens provided to it, it is <em>extremely dangerous</em>.  Any mistake can cause an invocation to fail to match all the above rules, thus falling down to this one and triggering an infinite recursion.</p>

<p>When you are writing, modifying, or debugging a macro like this, it is wise to temporarily prefix rules such as this one with something, such as <code>@entry</code>.  This prevents the infinite recursion case, and you are more likely to get matcher errors at the appropriate place.</p>

<pre class='rust rust-example-rendered'>
    ($(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>Ooks</span>:<span class='ident'>tt</span>)<span class='kw-2'>*</span>) <span class='op'>=&gt;</span> {
        <span class='macro'>Ook</span><span class='macro'>!</span>(@<span class='ident'>start</span> $(<span class='macro-nonterminal'>$</span><span class='macro-nonterminal'>Ooks</span>)<span class='kw-2'>*</span>)
    };
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20(%24(%24Ooks%3Att)*)%20%3D%3E%20%7B%0A%20%20%20%20%20%20%20%20Ook!(%40start%20%24(%24Ooks)*)%0A%20%20%20%20%7D%3B%0A%7D%0A%7D">Run</a></pre>

<h3 id='usage' class='section-header'><a href='#usage'>Usage</a></h3>
<p>Here, finally, is our test program.</p>

<pre class='rust rust-example-rendered'>
<span class='kw'>fn</span> <span class='ident'>main</span>() {
    <span class='kw'>let</span> _ <span class='op'>=</span> <span class='macro'>Ook</span><span class='macro'>!</span>(
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span><span class='question-mark'>?</span>  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='macro'>Ook</span><span class='macro'>!</span>  <span class='ident'>Ook</span><span class='question-mark'>?</span> <span class='macro'>Ook</span><span class='macro'>!</span>
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.
        <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='ident'>Ook</span>. <span class='ident'>Ook</span>.  <span class='macro'>Ook</span><span class='macro'>!</span> <span class='ident'>Ook</span>.
    );
}<a class="test-arrow" target="_blank" href="https://play.rust-lang.org/?code=fn%20main()%20%7B%0A%20%20%20%20let%20_%20%3D%20Ook!(%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook!%20Ook%3F%20%20Ook%3F%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%20%20Ook%3F%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook!%20Ook%3F%20%20Ook%3F%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook%3F%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%20%20Ook%3F%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook!%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook!%20Ook.%20%20Ook.%20Ook%3F%20%20Ook.%20Ook%3F%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook!%20Ook%3F%20%20Ook%3F%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook%3F%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%20%20Ook%3F%20Ook.%20%20Ook!%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook.%20Ook%3F%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook!%20Ook%3F%20%20Ook%3F%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook%3F%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%20%20Ook%3F%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook.%0A%20%20%20%20%20%20%20%20Ook%3F%20Ook.%20%20Ook%3F%20Ook.%20%20Ook%3F%20Ook.%20%20Ook%3F%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%0A%20%20%20%20%20%20%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%20%20Ook!%20Ook!%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook.%20Ook%3F%20%20Ook.%20Ook%3F%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook!%20Ook.%20%20Ook!%20Ook%3F%20%20Ook!%20Ook!%20%20Ook%3F%20Ook!%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook.%20Ook.%0A%20%20%20%20%20%20%20%20Ook.%20Ook.%20%20Ook.%20Ook.%20%20Ook!%20Ook.%0A%20%20%20%20)%3B%0A%7D%0A">Run</a></pre>

<p>The output when run (after a considerable pause for the compiler to do hundreds of recursive macro expansions) is:</p>

<pre><code class="language-text">Hello World!
</code></pre>

<p>With that, we have demonstrated the horrifying truth that <code>macro_rules!</code> is Turing-complete!</p>

<h3 id='an-aside' class='section-header'><a href='#an-aside'>An aside</a></h3>
<p>This was based on a macro implementing an isomorphic language called &quot;Hodor!&quot;.  Manish Goregaokar then <a href="https://www.reddit.com/r/rust/comments/39wvrm/hodor_esolang_as_a_rust_macro/cs76rqk?context=10000">implemented a Brainfuck interpreter using the Hodor! macro</a>.  So that is a Brainfuck interpreter written in Hodor! which was itself implemented using <code>macro_rules!</code>.</p>

<p>Legend has it that after raising the recursion limit to <em>three million</em> and allowing it to run for <em>four days</em>, it finally finished.</p>

<p>...by overflowing the stack and aborting.  To this day, esolang-as-macro remains a decidedly <em>non-viable</em> method of development with Rust.</p>

<div class="footnotes">
<hr>
<ol>

<li id="fn1">
<p>They <em>could</em> have been defined within the macro, but then they would have to have been explicitly passed around (due to hygiene).  To be honest, by the time I realised I <em>needed</em> to define these, the macro was already mostly written and... well, would <em>you</em> want to go through and fix this thing up if you didn&#39;t <em>absolutely need</em> to?&nbsp;<a href="#fnref1" rev="footnote">&#8617;</a></p>
</li>

<li id="fn2">
<p>It is a little known fact<sup id="fnref3"><a href="#fn3" rel="footnote">3</a></sup> that the story of Goldie Locks was actually an allegory for accurate lexical parsing techniques.&nbsp;<a href="#fnref2" rev="footnote">&#8617;</a></p>
</li>

<li id="fn3">
<p>And by &quot;fact&quot; I mean &quot;shameless fabrication&quot;.&nbsp;<a href="#fnref3" rev="footnote">&#8617;</a></p>
</li>

</ol>
</div>

    <script src='rustbook.js'></script>
</div></div>


</body>
</html>